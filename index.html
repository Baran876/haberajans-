<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yemek Yapma Oyunu</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f3e9;
        }
        .container {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #f7d794, #e29578);
        }
        .game-card {
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            max-width: 90%;
            width: 600px;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            border: 4px solid #b56576;
        }
        .btn {
            padding: 1rem 2rem;
            border-radius: 9999px;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 4px #8d3a4b;
        }
        .btn-primary {
            background-color: #b56576;
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px #8d3a4b;
        }
        .btn-secondary {
            background-color: #f08080;
            color: white;
            box-shadow: 0 4px #c25959;
        }
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px #c25959;
        }
        .ingredient-item {
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .ingredient-item:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .drop-zone {
            border: 3px dashed #b56576;
            background-color: #f7d794;
            transition: background-color 0.3s;
        }
        .drop-zone.drag-over {
            background-color: #e29578;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
        }
        .rank-item {
            transition: transform 0.2s;
        }
        .rank-item:hover {
            transform: translateY(-5px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="game-card">
            <!-- Loading Screen -->
            <div id="loadingScreen" class="flex flex-col items-center justify-center p-8">
                <div class="w-16 h-16 border-4 border-t-4 border-gray-200 rounded-full animate-spin border-b56576-500"></div>
                <p class="mt-4 text-lg font-semibold text-gray-700">Oyun Y√ºkleniyor...</p>
            </div>

            <!-- Main Menu -->
            <div id="mainMenu" class="hidden flex-col items-center justify-center text-center p-8">
                <h1 class="text-4xl font-bold text-[#b56576] mb-4">≈ûefin Mutfaƒüƒ±</h1>
                <p class="text-gray-700 mb-2">Kullanƒ±cƒ± ID: <span id="userIdDisplay" class="font-mono text-sm break-all"></span></p>
                <div class="mb-6 space-y-2">
                    <p class="text-lg font-semibold text-gray-800">Puan: <span id="scoreDisplay" class="text-xl font-bold text-teal-600">0</span></p>
                    <p class="text-lg font-semibold text-gray-800">R√ºtbe: <span id="rankDisplay" class="text-xl font-bold text-orange-600">Acemi</span></p>
                </div>
                <button id="startGameBtn" class="btn btn-primary w-full max-w-sm mb-4">Oyuna Ba≈üla</button>
                <button id="marketBtn" class="btn btn-secondary w-full max-w-sm">Markete Git</button>
            </div>

            <!-- Game Screen -->
            <div id="gameScreen" class="hidden flex-col">
                <div class="mb-4 text-center">
                    <p class="text-lg text-gray-700 font-semibold">Yapƒ±lacak Yemek:</p>
                    <h2 id="dishName" class="text-3xl font-bold text-[#b56576]"></h2>
                </div>
                <div class="mb-4 p-4 bg-gray-100 rounded-lg border border-gray-200">
                    <p class="text-lg font-semibold text-gray-800 mb-2">Gerekli Malzemeler:</p>
                    <ul id="requiredIngredientsList" class="flex flex-wrap gap-2 text-sm text-gray-600"></ul>
                </div>
                <!-- Drop Zone for the Dish -->
                <div id="dropZone" class="drop-zone p-8 rounded-lg mb-4 text-center font-semibold text-gray-800">
                    Malzemeleri Buraya S√ºr√ºkleyin!
                </div>
                <div class="p-4 bg-gray-100 rounded-lg border border-gray-200">
                    <p class="text-lg font-semibold text-gray-800 mb-2">Malzeme Tezgahƒ±:</p>
                    <div id="ingredientGrid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4"></div>
                </div>
                <div class="mt-4 text-center">
                    <p class="text-lg font-semibold text-gray-800">Puan: <span id="gameScoreDisplay" class="text-xl font-bold text-teal-600"></span></p>
                </div>
            </div>

            <!-- Market Screen -->
            <div id="marketScreen" class="hidden flex-col items-center">
                <h2 class="text-3xl font-bold text-[#b56576] mb-4">Market</h2>
                <p class="text-lg font-semibold text-gray-800 mb-4">Puanƒ±nƒ±z: <span id="marketScoreDisplay" class="text-xl font-bold text-teal-600">0</span></p>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full">
                    <!-- R√ºtbeler burada olu≈üturulacak -->
                </div>
                <button id="backToMenuBtn" class="btn btn-secondary w-full max-w-sm mt-6">Men√ºye D√∂n</button>
            </div>
        </div>
    </div>

    <!-- Modal for Messages -->
    <div id="modalOverlay" class="modal-overlay">
        <div id="modalContent" class="modal-content">
            <h3 id="modalTitle" class="text-2xl font-bold mb-2"></h3>
            <p id="modalMessage" class="mb-4 text-gray-700"></p>
            <button id="modalCloseBtn" class="btn btn-primary">Tamam</button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Debug i√ßin log seviyesini ayarlayƒ±n
        setLogLevel('debug');

        // Sabitler
        const dishes = [
            { name: "Spagetti Bolonez", ingredients: ["spagetti", "kƒ±yma", "domates sosu", "soƒüan", "sarƒ±msak"] },
            { name: "Lazanya", ingredients: ["lazanya hamuru", "be≈üamel sos", "kƒ±yma", "mozzarella"] },
            { name: "Tavuk Sote", ingredients: ["tavuk g√∂ƒüs√º", "biber", "domates", "soƒüan", "kekik"] },
            { name: "Mercimek √áorbasƒ±", ingredients: ["mercimek", "soƒüan", "havu√ß", "sal√ßa", "nane"] },
            { name: "ƒ∞skender Kebap", ingredients: ["d√∂ner eti", "pide", "yoƒüurt", "domates sosu", "tereyaƒüƒ±"] },
            { name: "Pirin√ß Pilavƒ±", ingredients: ["pirin√ß", "tereyaƒüƒ±", "su", "tuz"] },
            { name: "ƒ∞mam Bayƒ±ldƒ±", ingredients: ["patlƒ±can", "soƒüan", "domates", "sarƒ±msak", "maydanoz"] },
            { name: "Fƒ±rƒ±nda Tavuk", ingredients: ["b√ºt√ºn tavuk", "patates", "soƒüan", "biber", "kekik"] },
            { name: "Adana Kebap", ingredients: ["kuzu kƒ±yma", "pul biber", "soƒüan", "domates", "sal√ßa"] },
            { name: "Etli G√ºve√ß", ingredients: ["dana ku≈üba≈üƒ±", "patates", "havu√ß", "bezelye", "domates"] },
            { name: "Baklava", ingredients: ["yufka", "antep fƒ±stƒ±ƒüƒ±", "tereyaƒüƒ±", "≈üeker", "limon"] },
            { name: "Sarma", ingredients: ["asma yapraƒüƒ±", "pirin√ß", "kƒ±yma", "soƒüan", "baharat"] },
            { name: "Karnƒ±yarƒ±k", ingredients: ["patlƒ±can", "kƒ±yma", "soƒüan", "biber", "domates"] },
            { name: "Mantƒ±", ingredients: ["mantƒ± hamuru", "kƒ±yma", "yoƒüurt", "sarƒ±msak", "nane"] },
            { name: "G√ºlla√ß", ingredients: ["g√ºlla√ß yapraƒüƒ±", "s√ºt", "≈üeker", "g√ºl suyu", "nar"] },
            { name: "ƒ∞√ßli K√∂fte", ingredients: ["bulgur", "kƒ±yma", "soƒüan", "ceviz", "baharat"] },
            { name: "Ezogelin √áorbasƒ±", ingredients: ["mercimek", "bulgur", "pirin√ß", "sal√ßa", "nane"] },
            { name: "Kuru Fasulye", ingredients: ["kuru fasulye", "pastƒ±rma", "soƒüan", "domates sal√ßasƒ±", "sƒ±vƒ± yaƒü"] },
            { name: "Hamsi Tava", ingredients: ["hamsi", "mƒ±sƒ±r unu", "sƒ±vƒ± yaƒü", "tuz"] },
            { name: "Menemen", ingredients: ["yumurta", "domates", "biber", "soƒüan", "zeytinyaƒüƒ±"] },
            { name: "S√ºtla√ß", ingredients: ["pirin√ß", "s√ºt", "≈üeker", "vanilya"] },
            { name: "Kadayƒ±f Dolmasƒ±", ingredients: ["kadayƒ±f", "ceviz", "≈üeker", "tereyaƒüƒ±"] },
            { name: "Yaprak D√∂ner", ingredients: ["yaprak d√∂ner", "domates", "biber", "lava≈ü", "yoƒüurt"] },
            { name: "Sebzeli Musakka", ingredients: ["patlƒ±can", "kƒ±yma", "soƒüan", "biber", "domates"] },
            { name: "Tavuklu Pilav", ingredients: ["pirin√ß", "ha≈ülanmƒ±≈ü tavuk", "tereyaƒüƒ±", "karabiber"] },
            { name: "Sucuklu Yumurta", ingredients: ["yumurta", "sucuk", "tereyaƒüƒ±"] },
            { name: "Kumpir", ingredients: ["b√ºy√ºk patates", "ka≈üar peyniri", "tereyaƒüƒ±", "mƒ±sƒ±r", "sosis"] },
            { name: "Sigara B√∂reƒüi", ingredients: ["yufka", "beyaz peynir", "maydanoz"] },
            { name: "Kƒ±ymalƒ± Pide", ingredients: ["pide hamuru", "kƒ±yma", "soƒüan", "domates", "biber"] },
            { name: "Poƒüa√ßa", ingredients: ["un", "s√ºt", "yaƒü", "maya", "peynir"] },
            { name: "Ayran A≈üƒ± √áorbasƒ±", ingredients: ["yoƒüurt", "buƒüday", "nohut", "nane", "pul biber"] },
            { name: "Mercimek K√∂ftesi", ingredients: ["kƒ±rmƒ±zƒ± mercimek", "ince bulgur", "sal√ßa", "soƒüan", "maydanoz"] },
            { name: "Kƒ±sƒ±r", ingredients: ["ince bulgur", "domates sal√ßasƒ±", "biber sal√ßasƒ±", "soƒüan", "maydanoz"] },
            { name: "Dolma Biber", ingredients: ["dolmalƒ±k biber", "pirin√ß", "kƒ±yma", "soƒüan", "baharat"] },
            { name: "Tavuk ≈ûi≈ü", ingredients: ["tavuk", "biber", "domates", "soƒüan", "yoƒüurt"] },
            { name: "Sosisli Sandvi√ß", ingredients: ["sosis", "sandvi√ß ekmeƒüi", "ket√ßap", "mayonez"] },
            { name: "Hamburger", ingredients: ["hamburger k√∂ftesi", "hamburger ekmeƒüi", "marul", "domates", "tur≈üu"] },
            { name: "Pizza", ingredients: ["pizza hamuru", "mozzarella", "sucuk", "domates sosu", "mantar"] },
            { name: "Balƒ±k Ekmek", ingredients: ["balƒ±k", "ekmek", "marul", "soƒüan", "limon"] },
            { name: "Tost", ingredients: ["tost ekmeƒüi", "ka≈üar peyniri", "sucuk", "domates"] },
            { name: "G√∂zleme", ingredients: ["yufka", "patates", "peynir", "ƒ±spanak", "tereyaƒüƒ±"] },
            { name: "Kremalƒ± Mantar √áorbasƒ±", ingredients: ["mantar", "krema", "un", "tereyaƒüƒ±", "soƒüan"] },
            { name: "Tiramisu", ingredients: ["savoyar", "mascarpone peyniri", "yumurta", "kahve", "kakao"] },
            { name: "Cheesecake", ingredients: ["labne peyniri", "biskuvi", "tereyaƒüƒ±", "≈üeker", "krema"] },
            { name: "Brownie", ingredients: ["√ßikolata", "tereyaƒüƒ±", "≈üeker", "un", "yumurta"] },
            { name: "Profiterol", ingredients: ["hamur", "krema", "√ßikolata sosu", "yumurta", "tereyaƒüƒ±"] },
            { name: "Magnolia", ingredients: ["muhallebi", "muz", "√ßilek", "bebe bisk√ºvisi"] },
            { name: "Sufle", ingredients: ["√ßikolata", "tereyaƒüƒ±", "yumurta", "≈üeker", "un"] },
            { name: "Tavuklu Sezar Salata", ingredients: ["tavuk", "marul", "kƒ±tƒ±r ekmek", "parmesan", "sezar sos"] },
            { name: "Omlet", ingredients: ["yumurta", "peynir", "sucuk", "biber", "tereyaƒüƒ±"] },
        ];
        
        // Malzemelerin g√∂rselleri i√ßin emoji ve isim e≈üle≈ütirmesi
        const ingredientVisuals = {
            "spagetti": "üçù", "kƒ±yma": "ü•©", "domates sosu": "ü•´", "soƒüan": "üßÖ", "sarƒ±msak": "üßÑ",
            "lazanya hamuru": "üìú", "be≈üamel sos": "ü•£", "mozzarella": "üßÄ",
            "tavuk g√∂ƒüs√º": "üçó", "biber": "ü´ë", "domates": "üçÖ", "kekik": "üåø",
            "mercimek": "ü•£", "havu√ß": "ü•ï", "sal√ßa": "ü•´", "nane": "üçÉ",
            "d√∂ner eti": "üçñ", "pide": "üçû", "yoƒüurt": "ü•õ", "tereyaƒüƒ±": "üßà",
            "pirin√ß": "üçö", "su": "üíß", "tuz": "üßÇ", "patlƒ±can": "üçÜ", "maydanoz": "üåø",
            "b√ºt√ºn tavuk": "üçó", "patates": "ü•î", "kuzu kƒ±yma": "ü•©", "pul biber": "üå∂Ô∏è",
            "dana ku≈üba≈üƒ±": "ü•©", "bezelye": "üü¢", "yufka": "üìú", "antep fƒ±stƒ±ƒüƒ±": "üå∞",
            "asma yapraƒüƒ±": "ü•¨", "baharat": "üßÇ", "mantƒ± hamuru": "üìú",
            "g√ºlla√ß yapraƒüƒ±": "üìú", "s√ºt": "ü•õ", "≈üeker": "üçö", "g√ºl suyu": "üåπ", "nar": "üî¥",
            "bulgur": "üçö", "ceviz": "üå∞", "kƒ±rmƒ±zƒ± mercimek": "ü•£", "ince bulgur": "üçö",
            "kuru fasulye": "ü´ò", "pastƒ±rma": "ü•ì", "sƒ±vƒ± yaƒü": "üçæ", "hamsi": "üêü", "mƒ±sƒ±r unu": "üåæ",
            "yumurta": "ü•ö", "zeytinyaƒüƒ±": "üçæ", "vanilya": "üç¶", "kadayƒ±f": "üçú",
            "yaprak d√∂ner": "üçñ", "lava≈ü": "üåØ", "ha≈ülanmƒ±≈ü tavuk": "üçó", "karabiber": "üßÇ",
            "sucuk": "üå≠", "ka≈üar peyniri": "üßÄ", "mƒ±sƒ±r": "üåΩ", "sosis": "üå≠", "peynir": "üßÄ",
            "sandvi√ß ekmeƒüi": "ü•™", "ket√ßap": "üçÖ", "mayonez": "ü•£", "hamburger k√∂ftesi": "üçî",
            "hamburger ekmeƒüi": "üçî", "marul": "ü•¨", "tur≈üu": "ü•í", "pizza hamuru": "üçï",
            "mozzarella": "üßÄ", "mantar": "üçÑ", "balƒ±k": "üêü", "ekmek": "üçû", "limon": "üçã",
            "tost ekmeƒüi": "ü•™", "ƒ±spanak": "ü•¨", "krema": "ü•õ", "un": "üçö", "savoyar": "üìú",
            "mascarpone peyniri": "üßÄ", "kahve": "‚òï", "kakao": "üç´", "labne peyniri": "üßÄ",
            "biskuvi": "üç™", "√ßikolata": "üç´", "hamur": "üìú", "√ßikolata sosu": "üç´",
            "muhallebi": "ü•£", "muz": "üçå", "√ßilek": "üçì", "bebe bisk√ºvisi": "üç™",
            "kƒ±tƒ±r ekmek": "üçû", "parmesan": "üßÄ", "sezar sos": "ü•£",
            "salatalƒ±k": "ü•í", "avokado": "ü•ë", "karnabahar": "ü•¶", "brokoli": "ü•¶", "pƒ±rasa": "üßÖ", "kabak": "ü•í", "zeytin": "ü´í",
            "tur≈üu": "ü•í", "kabartma tozu": "üçö", "maya": "‚ö™", "kƒ±rmƒ±zƒ± soƒüan": "üßÖ", "yoƒüurt": "ü•õ", "nohut": "ü´ò", "buƒüday": "üåæ"
        };
        
        // R√ºtbeler ve maliyetleri
        const ranks = [
            { id: 0, name: "Acemi", cost: 0 },
            { id: 1, name: "√áƒ±rak ≈ûef", cost: 500 },
            { id: 2, name: "Gen√ß ≈ûef", cost: 2000 },
            { id: 3, name: "Usta ≈ûef", cost: 5000 },
            { id: 4, name: "Ba≈ü ≈ûef", cost: 10000 },
        ];

        // Global deƒüi≈ükenler
        let db, auth;
        let userId = 'default-user-id';
        let userPoints = 0;
        let userRankId = 0;
        let currentGameScore = 0;
        let currentDish = null;
        let ingredientsAdded = [];
        let isGameActive = false;
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // HTML elementleri
        const loadingScreen = document.getElementById('loadingScreen');
        const mainMenu = document.getElementById('mainMenu');
        const startGameBtn = document.getElementById('startGameBtn');
        const marketBtn = document.getElementById('marketBtn');
        const gameScreen = document.getElementById('gameScreen');
        const marketScreen = document.getElementById('marketScreen');
        const backToMenuBtn = document.getElementById('backToMenuBtn');
        const dishNameDisplay = document.getElementById('dishName');
        const requiredIngredientsList = document.getElementById('requiredIngredientsList');
        const ingredientGrid = document.getElementById('ingredientGrid');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const rankDisplay = document.getElementById('rankDisplay');
        const gameScoreDisplay = document.getElementById('gameScoreDisplay');
        const marketScoreDisplay = document.getElementById('marketScoreDisplay');
        const modalOverlay = document.getElementById('modalOverlay');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalCloseBtn = document.getElementById('modalCloseBtn');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const dropZone = document.getElementById('dropZone');

        // Firebase ve kimlik doƒürulama
        window.onload = async () => {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase kimlik doƒürulama hatasƒ±:", error);
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = userId;
                    listenToUserData();
                    loadingScreen.classList.add('hidden');
                    mainMenu.classList.remove('hidden');
                    mainMenu.style.display = 'flex';
                } else {
                    console.error("Kullanƒ±cƒ± kimliƒüi alƒ±namadƒ±.");
                }
            });

            // Drag and drop event listeners
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('drag-over');
            });
            dropZone.addEventListener('drop', handleDrop);
        };

        function listenToUserData() {
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/gameData/profile`);
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    userPoints = data.points || 0;
                    userRankId = data.rankId || 0;
                } else {
                    userPoints = 0;
                    userRankId = 0;
                    setDoc(userDocRef, { points: userPoints, rankId: userRankId });
                }
                updateUI();
            });
        }

        // UI G√ºncelleme Fonksiyonu
        function updateUI() {
            scoreDisplay.textContent = userPoints.toLocaleString();
            gameScoreDisplay.textContent = currentGameScore.toLocaleString();
            marketScoreDisplay.textContent = userPoints.toLocaleString();
            rankDisplay.textContent = ranks.find(r => r.id === userRankId).name;
            // Market ekranƒ±nƒ± yeniden olu≈ütur
            if (!marketScreen.classList.contains('hidden')) {
                renderMarketItems();
            }
        }

        // Modal (mesaj kutusu) g√∂sterme fonksiyonu
        function showModal(title, message, callback) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalOverlay.style.display = 'flex';
            modalCloseBtn.onclick = () => {
                modalOverlay.style.display = 'none';
                if (callback) callback();
            };
        }

        // Oyun Butonlarƒ±
        startGameBtn.addEventListener('click', () => {
            isGameActive = true;
            mainMenu.style.display = 'none';
            gameScreen.style.display = 'flex';
            startGame();
        });

        marketBtn.addEventListener('click', () => {
            mainMenu.style.display = 'none';
            marketScreen.style.display = 'flex';
            renderMarketItems();
            updateUI();
        });

        backToMenuBtn.addEventListener('click', () => {
            marketScreen.style.display = 'none';
            mainMenu.style.display = 'flex';
        });

        // Oyun Ba≈ülatma
        function startGame() {
            currentGameScore = 1000;
            ingredientsAdded = [];
            
            // Rastgele bir yemek se√ß
            const randomIndex = Math.floor(Math.random() * dishes.length);
            currentDish = dishes[randomIndex];
            
            dishNameDisplay.textContent = currentDish.name;
            gameScoreDisplay.textContent = currentGameScore.toLocaleString();
            
            // Gerekli malzemeleri g√∂rsel ve metinle listele
            requiredIngredientsList.innerHTML = currentDish.ingredients.map(ing => `
                <li class="p-2 bg-white rounded-lg border border-gray-300">
                    <span class="text-xl mr-1">${ingredientVisuals[ing] || '‚ùì'}</span>${ing}
                </li>
            `).join('');
            
            // Malzeme tezgahƒ±nƒ± hazƒ±rla
            renderIngredientGrid();
        }

        function renderIngredientGrid() {
            ingredientGrid.innerHTML = '';
            const allIngredients = [...currentDish.ingredients];
            // 3-5 tane rastgele yanlƒ±≈ü malzeme ekle
            const otherIngredients = Object.keys(ingredientVisuals).filter(ing => !currentDish.ingredients.includes(ing));
            const numOther = Math.floor(Math.random() * 3) + 3;
            for (let i = 0; i < numOther; i++) {
                const randomOther = otherIngredients[Math.floor(Math.random() * otherIngredients.length)];
                if (!allIngredients.includes(randomOther)) {
                    allIngredients.push(randomOther);
                }
            }

            // Karƒ±≈ütƒ±r
            allIngredients.sort(() => Math.random() - 0.5);

            allIngredients.forEach(ingredient => {
                const item = document.createElement('div');
                item.className = "ingredient-item bg-orange-200 p-4 rounded-lg text-center font-semibold text-orange-800 border border-orange-300";
                item.setAttribute('draggable', true);
                item.setAttribute('data-ingredient', ingredient);
                item.innerHTML = `<span class="text-3xl">${ingredientVisuals[ingredient] || '‚ùì'}</span>`;
                item.ondragstart = (e) => e.dataTransfer.setData('text/plain', ingredient);
                ingredientGrid.appendChild(item);
            });
        }

        function handleDrop(e) {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const ingredient = e.dataTransfer.getData('text/plain');
            addIngredient(ingredient);
        }

        function addIngredient(ingredient) {
            if (!isGameActive) return;

            const isCorrect = currentDish.ingredients.includes(ingredient);
            const alreadyAdded = ingredientsAdded.includes(ingredient);

            if (isCorrect && !alreadyAdded) {
                currentGameScore -= 50; // Doƒüru malzeme ekleyince puan kƒ±rƒ±lacak
                ingredientsAdded.push(ingredient);
                gameScoreDisplay.textContent = currentGameScore.toLocaleString();
                
                // Malzemeyi tezgahtan kaldƒ±r
                const ingredientItem = document.querySelector(`.ingredient-item[data-ingredient="${ingredient}"]`);
                if (ingredientItem) {
                    ingredientItem.style.display = 'none';
                }

                if (ingredientsAdded.length === currentDish.ingredients.length) {
                    endGame(true);
                }
            } else if (alreadyAdded) {
                showModal("Hata!", "Bu malzemeyi zaten eklediniz.", () => { /* no-op */ });
            } else {
                currentGameScore -= 100; // Yanlƒ±≈ü malzeme ekleyince daha √ßok puan kƒ±rƒ±lsƒ±n
                gameScoreDisplay.textContent = currentGameScore.toLocaleString();
                showModal("Yanlƒ±≈ü Malzeme!", "Bu yemekte bu malzeme kullanƒ±lmaz. Puanƒ±nƒ±zdan kesildi!", () => { /* no-op */ });
            }
        }

        function endGame(isSuccess) {
            isGameActive = false;
            let finalScore = currentGameScore;
            let message = "";
            let title = "";

            if (isSuccess && finalScore > 0) {
                title = "Tebrikler!";
                message = `Yemeƒüi tamamladƒ±nƒ±z ve ${finalScore} puan kazandƒ±nƒ±z!`;
                updatePoints(finalScore);
            } else {
                title = "Oyun Bitti!";
                message = "Yemeƒüi tamamlayamadƒ±nƒ±z veya puanƒ±nƒ±z t√ºkendi.";
            }

            showModal(title, message, () => {
                gameScreen.style.display = 'none';
                mainMenu.style.display = 'flex';
                updateUI();
            });
        }

        async function updatePoints(score) {
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/gameData/profile`);
            await setDoc(userDocRef, {
                points: userPoints + score,
                rankId: userRankId
            }, { merge: true });
        }

        // Market Fonksiyonlarƒ±
        function renderMarketItems() {
            const marketGrid = marketScreen.querySelector('.grid');
            marketGrid.innerHTML = '';
            
            ranks.forEach(rank => {
                const canBuy = userPoints >= rank.cost;
                const isCurrent = userRankId === rank.id;
                const isDisabled = userRankId >= rank.id;

                const item = document.createElement('div');
                item.className = `rank-item p-4 rounded-lg text-center font-bold border border-gray-300 flex flex-col justify-between ${isCurrent ? 'bg-green-100' : 'bg-gray-100'}`;
                item.innerHTML = `
                    <h3 class="text-xl text-gray-800">${rank.name}</h3>
                    <p class="text-sm font-normal text-gray-600 mb-2">${rank.cost > 0 ? `${rank.cost} Puan` : 'Mevcut R√ºtbe'}</p>
                    <button class="buy-btn btn w-full mt-2
                        ${canBuy && !isDisabled ? 'btn-primary' : 'bg-gray-400 cursor-not-allowed text-gray-600'}"
                        ${!canBuy || isDisabled ? 'disabled' : ''}>
                        ${isCurrent ? 'Mevcut' : (isDisabled ? 'Satƒ±n Alƒ±ndƒ±' : 'Satƒ±n Al')}
                    </button>
                `;

                const buyButton = item.querySelector('.buy-btn');
                buyButton.onclick = () => buyRank(rank.id);
                
                marketGrid.appendChild(item);
            });
        }

        async function buyRank(rankId) {
            const rankToBuy = ranks.find(r => r.id === rankId);
            if (!rankToBuy) return;
            
            if (userPoints >= rankToBuy.cost) {
                if (userRankId < rankToBuy.id) {
                    const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/gameData/profile`);
                    await setDoc(userDocRef, {
                        points: userPoints - rankToBuy.cost,
                        rankId: rankId
                    }, { merge: true });
                    showModal("Ba≈üarƒ±lƒ±!", `${rankToBuy.name} r√ºtbesini satƒ±n aldƒ±nƒ±z!`, () => { /* no-op */ });
                    updateUI();
                } else {
                    showModal("Hata!", "Bu r√ºtbe zaten sizde veya daha d√º≈ü√ºk.", () => { /* no-op */ });
                }
            } else {
                showModal("Hata!", "Yeterli puanƒ±nƒ±z yok.", () => { /* no-op */ });
            }
        }
    </script>
</body>
</html>
